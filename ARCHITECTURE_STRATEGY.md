# Стратегия архитектуры данных Analog Process

## Обзор

Приложение должно поддерживать два типа данных с разными источниками и способами синхронизации:
1. **Встроенные данные** - синхронизация с GitHub репозиторием
2. **Пользовательские данные** - локальное хранение с будущей синхронизацией через iCloud

## 1. Встроенные данные (GitHub синхронизация)

### Типы данных:
- **Режимы агитации** (AgitationModeData)
- **Пленки** (Films)
- **Проявители** (Developers)
- **Фиксажи** (Fixers)
- **Температурные множители** (TemperatureMultipliers)

### Преимущества GitHub подхода:
- Оперативные обновления без релиза приложения
- Версионный контроль данных
- Возможность сообщества добавлять новые режимы/материалы
- Откат к предыдущим версиям при проблемах

### Реализация:
```
Core/
├── Services/
│   ├── Data/
│   │   ├── GitHubDataSync/
│   │   │   ├── GitHubSyncService.swift
│   │   │   ├── BuiltInDataModels.swift
│   │   │   └── DataVersionManager.swift
│   │   └── LocalDataCache/
│   │       ├── CachedDataService.swift
│   │       └── DataCacheModels.swift
```

### Логика работы:
1. При запуске проверяем версию данных с GitHub
2. Если есть обновления - скачиваем и кешируем локально
3. Fallback на встроенные данные в bundle при отсутствии интернета
4. Периодическая фоновая синхронизация

## 2. Пользовательские данные (LocalStorage + Future iCloud)

### Типы данных:
- **Пользовательские записи времени проявки** (UserDevelopmentRecords)
- **Кастомные режимы агитации** (CustomAgitationModes)
- **Журнал проявок** (DevelopmentJournal)
- **Пользовательские настройки** (UserPreferences)

### Текущая реализация (Phase 1):
- SwiftData с локальным хранением
- Простое CRUD для пользовательских данных
- Отключение UI элементов iCloud

### Будущее развитие (Phase 2 - Future/):
```
Future/
├── CloudSync/
│   ├── iCloudSyncService.swift
│   ├── CloudKitModels.swift
│   ├── SyncConflictResolver.swift
│   └── CloudSyncUI/
│       ├── SyncStatusView.swift
│       └── ConflictResolutionView.swift
```

## 3. Архитектура данных

### Текущая структура SwiftData:
```swift
// Встроенные данные (read-only, синхронизация с GitHub)
@Model class BuiltInAgitationMode { ... }
@Model class BuiltInFilm { ... }
@Model class BuiltInDeveloper { ... }

// Пользовательские данные (read/write, локальное хранение)
@Model class UserDevelopmentRecord { ... }
@Model class CustomAgitationMode { ... }
```

### Предлагаемые изменения:

#### Phase 1 - Стабилизация локальных данных:
1. ✅ **Убрать AgitationModeData из SwiftData схемы**
2. ✅ **Создать GitHubDataService для встроенных режимов**
3. ✅ **Оставить только пользовательские модели в SwiftData**
4. ⏳ **Скрыть iCloud UI элементы**

#### Phase 2 - GitHub интеграция:
1. ✅ **Реализовать синхронизацию с GitHub API**
2. ✅ **Добавить кеширование и версионирование**
3. ✅ **Создать fallback механизмы**

#### Phase 3 - iCloud (Future/):
1. **Перенести в каталог Future/**
2. **CloudKit интеграция для пользовательских данных**
3. **Разрешение конфликтов синхронизации**
4. **Включить iCloud UI**

## 4. План реализации

### Немедленные действия:
1. ✅ Исключить AgitationModeData из SwiftData схемы
2. ✅ Создать GitHubDataService с встроенными данными
3. ✅ Реализовать локальное кеширование GitHub данных
4. ✅ Обновить UI для работы с новой архитектурой

### Выполненная работа:
- ✅ **JSON структура для agitation-modes.json** - создана и добавлена в GitHub репозиторий
- ✅ **GitHub модели данных** - GitHubAgitationResponse, GitHubAgitationModeData, GitHubAgitationRule
- ✅ **GitHubDataService** - добавлена загрузка режимов агитации с /agitation-modes.json
- ✅ **GitHubAgitationService** - сервис для кеширования и преобразования GitHub данных в AgitationMode
- ✅ **Интеграция с AgitationRuleEngine** - обновлен для использования GitHub данных вместо SwiftData
- ✅ **DataSyncService** - добавлена синхронизация режимов агитации
- ✅ **Fallback механизм** - при отсутствии GitHub данных используются встроенные режимы

### Среднесрочные задачи:
- ⏳ Скрыть iCloud UI элементы
- ⏳ Оптимизация производительности
- ⏳ Тестирование интеграции

### Долгосрочные задачи (Future/):
- iCloud синхронизация пользовательских данных
- Разрешение конфликтов синхронизации
- Офлайн режим с автосинхронизацией

## 5. Преимущества подхода

### Для разработчиков:
- Быстрые обновления режимов агитации
- Контроль версий данных
- Возможность A/B тестирования новых режимов

### Для пользователей:
- Всегда актуальные данные
- Сохранность пользовательских данных
- Быстрый доступ к данным (локальное кеширование)

### Для приложения:
- Стабильная работа без интернета
- Масштабируемая архитектура
- Изолированные компоненты (легче тестировать)

## 6. Риски и митигация

### Риски:
- GitHub API rate limits
- Проблемы с интернет-соединением
- Конфликты версий данных

### Митигация:
- Локальное кеширование с fallback
- Graceful degradation при отсутствии интернета
- Семантическое версионирование данных
- Откат к предыдущим версиям при проблемах

---

*Документ будет обновляться по мере развития архитектуры*